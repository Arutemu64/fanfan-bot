<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="MobileOptimized" content="176"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="robots" content="noindex,nofollow"/>
    <title>QR Scanner WebApp for FAN-FAN Telegram Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        function setThemeClass() {
            document.documentElement.className = Telegram.WebApp.colorScheme;
        }

        Telegram.WebApp.onEvent('themeChanged', setThemeClass);
        setThemeClass();

    </script>
</head>
<body>
    <script>
        Telegram.WebApp.ready();

        const isTelegramApiUpdated = Telegram.WebApp.isVersionAtLeast('6.4');
        const isTelegramClient = Telegram.WebApp.platform !== 'unknown';

        if (isTelegramClient && isTelegramApiUpdated) {
            Telegram.WebApp.MainButton
                .setText('⬅️ Назад')
                .show()
                .onClick(() => {
                    Telegram.WebApp.close();
                });

            const initData = Telegram.WebApp.initData || '';
            const initDataUnsafe = Telegram.WebApp.initDataUnsafe || {};

            Telegram.WebApp.showScanQrPopup(
                'Наведите смартфон на QR-код с логотипом фестиваля',
                (qrData) => {
                    fetch('qr_scanner', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            _auth: initData,
                            qr_data: qrData,
                        }),
                    })
                    .then((response) => {
                        if (response.ok) {
                            Telegram.WebApp.closeScanQrPopup();
                            Telegram.WebApp.close();
                        } else {
                            throw new Error('Failed to process QR data');
                        }
                    })
                    .catch((error) => {
                        console.error(error);
                        Telegram.WebApp.closeScanQrPopup();
                        Telegram.WebApp.close();
                    });
                }
            );
        } else if (isTelegramClient && !isTelegramApiUpdated) {
            Telegram.WebApp.showAlert('⚠️ Ваш клиент Telegram не поддерживает Bot API 6.4.\nПожалуйста, обновите приложение.');
            Telegram.WebApp.close();
        }
    </script>
</body>
</html>